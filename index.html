<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email Timeline Viewer</title>

  <style>
    body {
        font-family: sans-serif;
        background: #121212; /* dark background */
        color: #e0e0e0;      /* light text */
        padding: 20px;
    }

    #controls {
        margin-bottom: 20px;
        padding: 10px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    #timeline {
        position: relative;
        width: 100%;
        height: 140px;
        border-top: 2px solid #555;
    }

    .dot {
        position: absolute;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: steelblue;
        transform: translateX(-50%);
    }

    .dot-inbox {
        background: #4fc3f7; 
        top: 20px;
    }

    .dot-sent {
        background: #ffb74d; 
        top: -20px;
    }
    
    .dot-marked {
        border: 2px solid #ff4081; 
    }

    .dot-inbox.marked-boost {
        top: 50px !important;   /* was 20px */
    }

    .dot-sent.marked-boost {
        top: -50px !important;  /* was -20px */
    }

    .label {
        position: absolute;
        top: 60px;
        font-size: 12px;
        color: #ccc;
        transform: translateX(-50%);
    }

    #tools-panel {
        background: #1f1f1f;  /* slightly lighter dark panel */
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.6);
        padding: 15px;
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 15px;
    }

    .tool-section {
        display: flex;
        flex-direction: column;
        min-width: 150px;
    }

    .tool-section label {
        color: #e0e0e0;
    }

    input, button {
        background: #2a2a2a;
        border: 1px solid #444;
        color: #e0e0e0;
        border-radius: 5px;
        padding: 5px 10px;
    }

    input::placeholder {
        color: #999;
    }

    button:hover {
        background: #444;
        cursor: pointer;
    }

    h1 {
        margin-bottom: 150px;
    }

  </style>
</head>

<body>

    <h1>Email Timeline Viewer</h1>

    <!-- TIMELINE -->
    <div id="timeline"></div>

    <!-- FILE INPUT CONTROL -->
    <div id="tools-panel">
        <div class="tool-section">
            <label><strong>Inbox (JSON):</strong></label>
            <input type="file" id="json-inbox" accept=".json">
        </div>

        <div class="tool-section">
            <label><strong>Sent (JSON):</strong></label>
            <input type="file" id="json-sent" accept=".json">
        </div>

        <div class="tool-section">
            <label><strong>Mark Address:</strong></label>
            <input id="mark-input" type="text" placeholder="someone@example.com">
            <button id="add-mark">Add</button>
        </div>

        <div class="tool-section">
            <div id="marked-list"><strong>Marked:</strong><br></div>
        </div>

        <div class="tool-section">
            <label><strong>Exclude Address:</strong></label>
            <input id="exclude-input" type="text" placeholder="blocked@example.com">
            <button id="add-exclude">Exclude</button>
        </div>

        <div class="tool-section">
            <div id="excluded-list"><strong>Excluded:</strong><br></div>
        </div>

    </div>

    <script>
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // flash effect on click
                console.log("Copied:", text);
            }).catch(err => {
                console.error("Copy failed:", err);
            });
        }


        // State
        let sentEvents = [];
        let inboxEvents = [];
        let markedSenders = new Set();
        let excludedSenders = new Set();


        function loadJSON(fileInput, targetArray) {
            fileInput.addEventListener("change", (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                try {
                    targetArray.length = 0;
                    const data = JSON.parse(e.target.result);
                    targetArray.push(...data);
                    renderTimeline();
                } catch(err) {
                    alert("Invalid JSON file");
                }
                };
                reader.readAsText(file);
            });
        }

        loadJSON(document.getElementById("json-sent"), sentEvents);
        loadJSON(document.getElementById("json-inbox"), inboxEvents);

        // Add address to exclude list
        document.getElementById("add-exclude").onclick = () => {
            const input = document.getElementById("exclude-input");
            const value = input.value.trim().toLowerCase();
            if (value) {
                excludedSenders.add(value);
                input.value = "";
                updateExcludedList();
                renderTimeline();
            }
        };

        // Add sender to marked list
        document.getElementById("add-mark").onclick = () => {
            const input = document.getElementById("mark-input");
            const value = input.value.trim().toLowerCase(); // normalize
            if(value) {
                markedSenders.add(value);
                input.value = "";
                updateMarkedList();
                renderTimeline();
            }
        };

        function updateExcludedList() {
            const div = document.getElementById("excluded-list");
            div.innerHTML = "<strong>Excluded:</strong><br>";

            excludedSenders.forEach(sender => {
                const line = document.createElement("div");
                line.textContent = sender;
                line.style.cursor = "pointer";

                line.onmouseover = () => line.style.color = "#ff8080";
                line.onmouseout  = () => line.style.color = "";

                // Click → remove
                line.onclick = () => {
                    excludedSenders.delete(sender);
                    updateExcludedList();
                    renderTimeline();
                };

                div.appendChild(line);
            });
        }


        function updateMarkedList() {
            const div = document.getElementById("marked-list");
            div.innerHTML = "<strong>Marked:</strong><br>";

            markedSenders.forEach(sender => {
                const line = document.createElement("div");
                line.textContent = sender;
                line.style.cursor = "pointer";

                // Hover highlight
                line.onmouseover = () => line.style.color = "#ff8080";
                line.onmouseout  = () => line.style.color = "";

                // Click → remove
                line.onclick = () => {
                    markedSenders.delete(sender);
                    updateMarkedList();
                    renderTimeline();
                };

                div.appendChild(line);
            });
        }



        function renderTimeline() {
            const timeline = document.getElementById("timeline");
            timeline.innerHTML = ""; // clear timeline

            const filteredSent = sentEvents;
            const filteredInbox = inboxEvents;
            const allEvents = [...filteredSent, ...filteredInbox];
            if(allEvents.length === 0) return;



            // Normalize the timeline
            const times = allEvents.map(e => new Date(e.timestamp).getTime());
            const minTime = Math.min(...times);
            const maxTime = Math.max(...times);
            const duration = maxTime - minTime;

            function xPos(t) {
                return ((t - minTime) / duration) * 100;
            }

            // Add date labels (overview)
            const labelCount = 5;
            const step = (maxTime - minTime) / (labelCount - 1);
            const labelTimes = Array.from({length: labelCount}, (_, i) => minTime + i * step);

            for (const t of labelTimes) {
                const label = document.createElement("div");
                label.className = "label";
                label.style.left = ((t - minTime) / duration) * 100 + "%";
                label.textContent = new Date(t).toLocaleDateString();
                timeline.appendChild(label);
            }

            // Inbox dots (below)
            for (const e of inboxEvents) {
                const t = new Date(e.timestamp).getTime();
                const dot = document.createElement("div");
                dot.classList.add("dot", "dot-inbox");

                const sender = e.sender?.trim().toLowerCase();

                // Excluded → skip rendering
                if (sender && excludedSenders.has(sender)) continue;

                // Marked → boost
                if (sender && markedSenders.has(sender)) {
                    dot.classList.add("dot-marked", "marked-boost");
                }


                dot.style.left = xPos(t) + "%";

                const bodyPreview = e.body ? e.body.replace(/\n/g, ' ').slice(0, 200) + (e.body.length > 200 ? "…" : "") : "";

                dot.title =
                    `From: ${e.sender}\n` +
                    `Subject: ${e.subject}\n` +
                    `Date: ${e.timestamp}\n\n${bodyPreview}`;

                dot.onclick = () => {
                    const sender = e.sender?.trim() || "";
                    if (sender) copyToClipboard(sender);
                };

                timeline.appendChild(dot);

            }

            // Sent dots (top)
            for (const e of sentEvents) {
                const t = new Date(e.timestamp).getTime();
                const dot = document.createElement("div");
                dot.classList.add("dot", "dot-sent");

                // --- Exclude by RECEIVER ---
                let isExcluded = false;
                let isMarked = false;

                if (Array.isArray(e.receivers)) {
                    for (const r of e.receivers) {
                        const clean = r.trim().toLowerCase();
                        if (excludedSenders.has(clean)) {
                            isExcluded = true;
                            break;
                        }
                        if (markedSenders.has(clean)) {
                            isMarked = true;
                        }
                    }
                }

                if (isExcluded) continue;


                if (isMarked) {
                    dot.classList.add("dot-marked", "marked-boost");
                }

                dot.style.left = xPos(t) + "%";

                const bodyPreview = e.body ? e.body.replace(/\n/g, ' ').slice(0, 200) + (e.body.length > 200 ? "…" : "") : "";

                dot.title =
                    `From: ${e.sender}\n` +
                    `To: ${Array.isArray(e.receivers) ? e.receivers.join(", ") : "?"}\n` +
                    `Subject: ${e.subject}\n` +
                    `Date: ${e.timestamp}\n\n${bodyPreview}`;

                dot.onclick = () => {
                    let toCopy = "";
                    if (Array.isArray(e.receivers)) {
                        toCopy = e.receivers.join(", ");
                    }
                    if (toCopy) copyToClipboard(toCopy);
                };

                timeline.appendChild(dot);

            }
        }
    </script>
</body>
</html>
